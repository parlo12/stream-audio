# Secure mosquitto.conf (overwrites any existing dev one)
sudo tee /opt/mqtt/conf/mosquitto.conf >/dev/null <<'EOF'
per_listener_settings true

# VPC-only listener (firewall already blocks the public IP)
listener 1883 0.0.0.0

# REQUIRE auth
allow_anonymous false
password_file /mosquitto/config/passwd

# Keep payloads reasonable; use Spaces/S3 for real file uploads
max_packet_size 20971520
EOF

# docker-compose.yml for the broker
sudo tee /opt/mqtt/docker-compose.yml >/dev/null <<'YAML'
version: "3.9"
services:
  mosquitto:
    image: eclipse-mosquitto:2
    restart: always
    ports:
      - "1883:1883"      # leave 8883 closed until you add TLS
    volumes:
      - ./conf/mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./conf/passwd:/mosquitto/config/passwd:ro
      - ./certs:/mosquitto/config/certs:ro
YAML