version: "3.9"

services:
  # ── MQTT Broker ─────────────────────────────────
  mqtt-broker:
    image: eclipse-mosquitto:latest
    restart: always
    ports:
      - "1883:1883"
      - "8883:8883"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf:ro
      - ./mosquitto/certs:/mosquitto/config/certs:ro

  # ── Redis ────────────────────────────────────────
  redis:
    image: redis:alpine
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

  # ── MinIO ────────────────────────────────────────
  minio:
    image: minio/minio:latest
    restart: always
    command: server /data
    environment:
      MINIO_ROOT_USER:     "${MINIO_ROOT_USER}"
      MINIO_ROOT_PASSWORD: "${MINIO_ROOT_PASSWORD}"
    ports:
      - "9000:9000"
    volumes:
      - minio-data:/data

  # ── API Gateway ──────────────────────────────────
  gateway:
    build: ./gateway
    restart: always
    ports:
      - "8080:8080"
    depends_on:
      - auth-service

  # ── Auth Service ────────────────────────────────
  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    restart: always
    ports:
      - "8082:8082"
    depends_on:
      - redis
    env_file:
      - .env
    volumes:
      # mount DO’s CA so lib/pq & psql can verify SSL
      - ./certs/do-postgres-ca.crt:/certs/do-postgres-ca.crt:ro
    environment:
      # database (managed DO cluster) settings:
      DB_HOST:        "${DB_HOST}"
      DB_PORT:        "${DB_PORT}"
      DB_NAME:        "${DB_NAME}"
      DB_USER:        "${DB_USER}"
      DB_PASSWORD:    "${DB_PASSWORD}"
      # pass through your new flag:
      DB_SSLMODE: "${DB_SSLMODE:-disable}"

      # enforce SSL
      #PGSSLMODE:      require
      #PGSSLROOTCERT:  /certs/do-postgres-ca.crt

      # other vars:
      JWT_SECRET:     "${JWT_SECRET}"
      REDIS_URL:      "redis://redis:6379"
      GIN_MODE:       "release"

  # ── Content Service ─────────────────────────────
  content-service:
    build: ./content-service
    restart: always
    ports:
      - "8083:8083"
    depends_on:
      - redis
      - minio
      - mqtt-broker
    env_file:
      - .env
    volumes:
      - ./certs/do-postgres-ca.crt:/certs/do-postgres-ca.crt:ro
    environment:
      # database (managed DO cluster) settings:
      DB_HOST:        "${DB_HOST}"
      DB_PORT:        "${DB_PORT}"
      DB_NAME:        "${DB_NAME}"
      DB_USER:        "${DB_USER}"
      DB_PASSWORD:    "${DB_PASSWORD}"
      # pass through your new flag:
      DB_SSLMODE: "${DB_SSLMODE:-disable}"
      # PGSSLMODE:      require
      # PGSSLROOTCERT:  /certs/do-postgres-ca.crt

      # other vars:
      OPENAI_API_KEY:      "${OPENAI_API_KEY}"
      XI_API_KEY:          "${XI_API_KEY}"
      ELEVENLABS_VOICE_ID: "${ELEVENLABS_VOICE_ID}"
      JWT_SECRET:          "${JWT_SECRET}"
      RESPONSE_FORMAT:     "opus"
      GIN_MODE:            "release"
      MQTT_BROKER:         "tcp://mqtt-broker:1883"

volumes:
  redis-data:
  minio-data: